services:
  # MCP Skills Server
  mcp-server:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=INFO
      - SKILLS_DIR=/app/skills
      - SKILLS_WATCH_ENABLED=true
      - STORAGE_BACKEND=local
      # Uncomment below to use S3 mode with local services:
      # - STORAGE_BACKEND=s3
      # - S3_ENDPOINT_URL=http://localstack:4566
      # - S3_SKILLS_BUCKET=mcp-skills-bucket
      # - DYNAMODB_ENDPOINT_URL=http://dynamodb-local:8000
      # - SKILL_CACHE_DIR=/tmp/skill-cache
      # - AWS_ACCESS_KEY_ID=test
      # - AWS_SECRET_ACCESS_KEY=test
      # - AWS_REGION=us-east-1
    volumes:
      - ./skills:/app/skills:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # depends_on:
    #   dynamodb-local:
    #     condition: service_started
    #   localstack:
    #     condition: service_started

  # DynamoDB Local (for development)
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    ports:
      - "8001:8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb"]
    restart: unless-stopped

  # LocalStack (S3)
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
    restart: unless-stopped

  # # Redis (多实例同步时启用)
  # redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   restart: unless-stopped
